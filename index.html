<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Jackie's SQL ❤️</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        /* --------------------------------------------------
           THEMES (CSS Variables)
        -------------------------------------------------- */
        :root[data-theme="light"] {
            --bg-main: #f8fafc;
            --bg-card: #ffffff;
            --bg-sidebar: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --surface-hover: #f1f5f9;
            --editor-bg: #1e1e2e; /* Editor always dark for contrast */
            --editor-text: #a6accd;
            --accent-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --shadow-subtle: 0 4px 6px -1px rgba(0,0,0,0.05);
        }

        :root[data-theme="dark"] {
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --bg-sidebar: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border-color: #334155;
            --surface-hover: #334155;
            --editor-bg: #020617;
            --editor-text: #e2e8f0;
            --accent-gradient: linear-gradient(135deg, #818cf8 0%, #c084fc 100%);
            --shadow-subtle: 0 4px 6px -1px rgba(0,0,0,0.3);
        }

        /* Core Constants */
        :root {
            --primary-color: #6366f1;
            --success-color: #10b981;
            --error-color: #ef4444;
            --font-main: 'Outfit', sans-serif;
            --font-code: 'JetBrains Mono', monospace;
            --sa-top: env(safe-area-inset-top);
            --sa-bottom: env(safe-area-inset-bottom);
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-main);
            color: var(--text-main);
            height: 100dvh;
            overflow: hidden;
            margin: 0;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --------------------------------------------------
           LAYOUT
        -------------------------------------------------- */
        .app-container { display: flex; height: 100%; width: 100vw; position: relative; }

        .sidebar {
            width: 280px; background-color: var(--bg-sidebar); border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column; flex-shrink: 0; 
            position: fixed; left: -280px; top: 0; height: 100%; z-index: 1050;
            transition: transform 0.3s ease; box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            padding-top: var(--sa-top); padding-bottom: var(--sa-bottom);
        }
        .sidebar.active { transform: translateX(280px); }
        .sidebar-backdrop {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px);
            z-index: 1040; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .sidebar-backdrop.active { opacity: 1; pointer-events: auto; }

        @media (min-width: 992px) {
            .sidebar { position: relative; left: 0; transform: none; box-shadow: none; }
            .sidebar-backdrop { display: none; }
        }

        .main-content { flex: 1; display: flex; flex-direction: column; width: 100%; background: var(--bg-main); }

        .navbar-custom {
            background: var(--bg-card); border-bottom: 1px solid var(--border-color);
            padding: 0.8rem 1.25rem; padding-top: calc(0.8rem + var(--sa-top));
            display: flex; justify-content: space-between; align-items: center; z-index: 100;
        }

        /* --------------------------------------------------
           COMPONENTS
        -------------------------------------------------- */
        .brand-logo {
            font-weight: 800; font-size: 1.4rem;
            background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-decoration: none; display: flex; align-items: center; gap: 10px;
        }

        .level-accordion .accordion-button {
            background: var(--bg-sidebar); color: var(--text-main); font-weight: 700;
            box-shadow: none; border-bottom: 1px solid var(--border-color);
        }
        .level-accordion .accordion-button:not(.collapsed) { color: var(--primary-color); background: var(--surface-hover); }
        .lesson-item {
            padding: 12px 15px 12px 35px; cursor: pointer; color: var(--text-muted); font-size: 0.9rem;
            display: flex; justify-content: space-between; align-items: center; border-left: 3px solid transparent;
        }
        .lesson-item:hover { background: var(--surface-hover); color: var(--text-main); }
        .lesson-item.active { border-left-color: var(--primary-color); background: var(--surface-hover); color: var(--primary-color); font-weight: 600; }
        .lesson-item.completed i { color: var(--success-color); }

        /* --------------------------------------------------
           WORKSPACE
        -------------------------------------------------- */
        .workspace-container { display: flex; flex-direction: column; height: 100%; overflow-y: hidden; }
        
        .lesson-instructions {
            background: var(--bg-card); border-bottom: 1px solid var(--border-color); padding: 1.5rem;
            overflow-y: auto; flex-shrink: 0; max-height: 40vh; color: var(--text-main);
        }
        @media (max-width: 991px) { .lesson-instructions { max-height: none; flex: 1; } }

        .editor-area { 
            display: flex; flex-direction: column; gap: 1rem; padding: 1rem; flex: 1; overflow-y: auto; 
            background: var(--bg-main);
        }
        @media (min-width: 992px) { 
            .editor-area { flex-direction: row; overflow: hidden; }
            .editor-col, .results-col { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        }

        .code-editor-container {
            background: var(--editor-bg); border-radius: 12px; overflow: hidden; display: flex; flex-direction: column;
            min-height: 200px; border: 1px solid var(--border-color); flex: 1;
        }
        .code-editor-container.success-glow { border-color: var(--success-color); box-shadow: 0 0 0 2px rgba(16,185,129,0.3); }

        .editor-with-lines {
            display: flex;
            height: 100%;
            flex-grow: 1;
            position: relative;
            overflow: hidden;
        }
        .line-numbers {
            background: var(--editor-bg);
            color: var(--text-muted);
            padding: 1rem 0.5rem;
            text-align: right;
            user-select: none;
            font-family: var(--font-code);
            font-size: 16px;
            line-height: 1.5;
            min-width: 2.5rem;
            border-right: 1px solid rgba(255,255,255,0.1);
            opacity: 0.5;
            overflow: hidden; /* Hide scrollbar for lines */
        }

        textarea#sql-editor {
            flex: 1; background: transparent; color: var(--editor-text); border: none; padding: 1rem;
            font-family: var(--font-code); font-size: 16px; resize: none; outline: none; line-height: 1.5;
            white-space: pre; overflow-wrap: normal; overflow: auto;
        }

        .results-area {
            background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px;
            overflow: hidden; display: flex; flex-direction: column; flex: 1; min-height: 200px;
        }
        .results-content { overflow: auto; overflow-x: auto; flex: 1; }

        /* Table */
        .table-custom { width: 100%; border-collapse: collapse; font-size: 0.9rem; white-space: nowrap; }
        .table-custom th {
            background: var(--surface-hover); color: var(--text-muted); font-weight: 700; padding: 12px 16px;
            text-align: left; position: sticky; top: 0; border-bottom: 1px solid var(--border-color);
        }
        .table-custom td { border-bottom: 1px solid var(--border-color); padding: 10px 16px; color: var(--text-main); }
        .table-custom tr:last-child td { border-bottom: none; }

        /* --------------------------------------------------
           UTILITIES
        -------------------------------------------------- */
        .btn-theme { background: transparent; border: none; color: var(--text-muted); font-size: 1.2rem; }
        .btn-run {
            background: var(--accent-gradient); color: white; border: none; padding: 0.5rem 1.5rem;
            border-radius: 8px; font-weight: 600; display: inline-flex; align-items: center; gap: 8px;
            transition: transform 0.2s;
        }
        .btn-run:active { transform: scale(0.95); }
        .btn-success-custom { background: #10b981; color: white; border: none; padding: 0.5rem 1.5rem; border-radius: 8px; font-weight: 600; }
        
        .status-msg { margin-top: 10px; padding: 10px; border-radius: 8px; font-size: 0.9rem; display: none; }
        .status-success { background: rgba(16,185,129,0.1); color: #10b981; border: 1px solid #10b981; }
        .status-error { background: rgba(239,68,68,0.1); color: #ef4444; border: 1px solid #ef4444; }

        /* Landing */
        .landing-container { 
            height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: var(--bg-main); text-align: center; padding: 2rem;
        }
        .hero-card {
            background: var(--bg-card); padding: 3rem; border-radius: 24px; border: 1px solid var(--border-color);
            box-shadow: var(--shadow-subtle); max-width: 600px; width: 100%;
        }
        .floating-blob {
            position: absolute; width: 300px; height: 300px; background: var(--primary-color);
            filter: blur(80px); opacity: 0.15; border-radius: 50%; z-index: 0; animation: float 10s infinite alternate;
        }
        @keyframes float { from { transform: translate(0,0); } to { transform: translate(20px, -20px); } }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="sidebar-backdrop" id="sidebarBackdrop" onclick="app.toggleSidebar(false)"></div>

    <nav class="sidebar" id="sidebar">
        <div class="p-4 d-flex justify-content-between align-items-center">
            <a href="#" class="brand-logo" onclick="app.renderLanding()">
                <i class="fas fa-database"></i> Jackie's SQL ❤️
            </a>
            <button class="btn-theme d-lg-none" onclick="app.toggleSidebar(false)"><i class="fas fa-times"></i></button>
        </div>
        
        <div class="overflow-auto flex-grow-1">
            <div class="accordion level-accordion" id="curriculumAccordion"></div>
        </div>

        <div class="p-4 border-top border-secondary border-opacity-10 bg-surface">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <small class="fw-bold text-muted">XP</small>
                <span class="badge bg-success rounded-pill" id="total-xp">0 XP</span>
            </div>
            <div class="progress" style="height: 6px;">
                <div class="progress-bar bg-success" id="overall-progress" style="width: 0%"></div>
            </div>
            <button class="btn btn-sm btn-outline-danger w-100 mt-3" onclick="app.resetProgress()">Reset</button>
        </div>
    </nav>

    <main class="main-content">
        <header class="navbar-custom">
            <div class="d-flex align-items-center gap-3">
                <button class="btn-theme d-lg-none" onclick="app.toggleSidebar(true)"><i class="fas fa-bars"></i></button>
                <h5 class="m-0 fw-bold" id="page-title">Dashboard</h5>
            </div>
            <div class="d-flex gap-3 align-items-center">
                <button class="btn-theme" onclick="app.toggleTheme()" title="Toggle Theme"><i class="fas fa-moon" id="theme-icon"></i></button>
                <button class="btn btn-sm btn-outline-primary" onclick="app.showCheatSheet()">Cheat Sheet</button>
                <button class="btn btn-sm btn-outline-secondary" onclick="app.showSchema()">Schema</button>
            </div>
        </header>

        <div id="content-area" class="workspace-container"></div>
    </main>
</div>

<!-- Modals -->
<div class="modal fade" id="schemaModal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-scrollable"><div class="modal-content" style="background:var(--bg-card); color:var(--text-main);"><div class="modal-header border-bottom border-secondary border-opacity-10"><h5 class="modal-title">Schema</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="row g-3" id="schema-container"></div></div></div></div></div>
<div class="modal fade" id="cheatSheetModal" tabindex="-1"><div class="modal-dialog modal-xl modal-dialog-scrollable"><div class="modal-content" style="background:var(--bg-card); color:var(--text-main);"><div class="modal-header border-bottom border-secondary border-opacity-10"><h5 class="modal-title">Interview Prep & Cheat Sheet</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="row g-3" id="cheat-sheet-content"></div></div></div></div></div>
<div class="modal fade" id="aiModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content" style="background:var(--bg-card); color:var(--text-main);"><div class="modal-header border-0"><h5 class="modal-title text-primary">AI Tutor</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="aiModalContent"></div></div></div></div>

<script>
const apiKey = "AIzaSyB5OFECsjjTXOk_gTjAizxBxWTiYh9R93w"; // Set at runtime

/* ------------------------------------------------------------------
   1. DATABASE (Expanded for Advanced Lessons)
------------------------------------------------------------------ */
const DB = {
    employees: [
        { id: 1, name: 'John Doe', department: 'Sales', salary: 50000, join_date: '2020-01-15' },
        { id: 2, name: 'Jane Smith', department: 'Engineering', salary: 80000, join_date: '2019-03-23' },
        { id: 3, name: 'Sam Brown', department: 'Sales', salary: 55000, join_date: '2021-06-01' },
        { id: 4, name: 'Lisa White', department: 'HR', salary: 45000, join_date: '2022-01-10' },
        { id: 5, name: 'Mike Green', department: 'Engineering', salary: 82000, join_date: '2018-11-05' },
        { id: 6, name: 'Anna Black', department: 'Engineering', salary: 80000, join_date: '2023-02-15' }
    ],
    sales: [
        { id: 101, employee_id: 1, amount: 5000, date: '2023-01-01' },
        { id: 102, employee_id: 1, amount: 3000, date: '2023-01-02' },
        { id: 103, employee_id: 3, amount: 7000, date: '2023-01-01' },
        { id: 104, employee_id: 3, amount: 2000, date: '2023-01-03' }
    ],
    users: [
        { id: 1, name: 'Alice', email: 'alice@test.com', role: 'admin' },
        { id: 2, name: 'Bob', email: 'bob@test.com', role: null },
        { id: 3, name: 'Charlie', email: 'charlie@test.com', role: 'user' },
        { id: 4, name: 'Bob', email: 'bob@test.com', role: 'user' } // Duplicate for cleaning lesson
    ]
};

/* ------------------------------------------------------------------
   2. SQL ENGINE v3.0 (Merged & Robust)
------------------------------------------------------------------ */
const SQLEngine = {
    // Utility to split columns respecting parentheses
    splitColumns: function(str) {
        const result = [];
        let current = '';
        let depth = 0;
        for (let char of str) {
            if (char === '(') depth++;
            if (char === ')') depth--;
            if (char === ',' && depth === 0) {
                result.push(current.trim());
                current = '';
            } else {
                current += char;
            }
        }
        if (current) result.push(current.trim());
        return result;
    },

    execute: function(query) {
        try {
            let cleanQuery = query.trim().replace(/;/g, '');
            // Handle CTE (WITH clause)
            if (cleanQuery.toUpperCase().startsWith('WITH')) {
                return this.handleCTE(cleanQuery);
            }
            // Standard Execution
            return this.processQuery(cleanQuery);
        } catch (e) { return { error: e.message }; }
    },

    handleCTE: function(query) {
        const cteMatch = query.match(/WITH\s+(\w+)\s+AS\s*\(([\s\S]+?)\)\s*(SELECT[\s\S]+)/i);
        if (!cteMatch) throw new Error("Invalid CTE syntax. Use: WITH name AS (query) SELECT ...");
        
        const cteName = cteMatch[1];
        const cteQuery = cteMatch[2];
        const mainQuery = cteMatch[3];

        // Run CTE query
        const cteResult = this.processQuery(cteQuery);
        if (cteResult.error) throw new Error(`CTE Error: ${cteResult.error}`);

        // Temporarily add CTE result to DB
        const originalDB = DB[cteName]; 
        DB[cteName] = cteResult.data;

        try {
            const result = this.processQuery(mainQuery);
            delete DB[cteName]; // Cleanup
            if (originalDB) DB[cteName] = originalDB; // Restore
            return result;
        } catch (e) {
            delete DB[cteName];
            throw e;
        }
    },

    processQuery: function(query) {
        const command = query.split(/\s+/)[0].toUpperCase();
        
        if (['CREATE','ALTER','DROP','TRUNCATE','INSERT','UPDATE','DELETE','GRANT','REVOKE'].includes(command)) {
            return { message: `✅ Command '${command}' executed successfully (Simulation Mode).` };
        }
        
        if (command !== 'SELECT') throw new Error("Only SELECT is fully supported in this engine.");

        // --- 1. FROM & JOIN ---
        const fromMatch = query.match(/FROM\s+([a-zA-Z0-9_]+)/i);
        if (!fromMatch) throw new Error("Missing FROM clause");
        const tableName = fromMatch[1];
        
        if (!DB[tableName]) throw new Error(`Table '${tableName}' not found.`);
        let results = JSON.parse(JSON.stringify(DB[tableName]));

        // Handle JOINS
        const joinMatch = query.match(/JOIN\s+([a-zA-Z0-9_]+)\s+ON\s+(.+?)(?=\s+(?:WHERE|GROUP|ORDER|LIMIT|HAVING)|$)/i);
        if (joinMatch) {
            const joinTable = joinMatch[1];
            const onCond = joinMatch[2];
            if (!DB[joinTable]) throw new Error(`Joined table '${joinTable}' not found.`);
            const [l, r] = onCond.split('=').map(s => s.trim());
            const lCol = l.split('.')[1] || l;
            const rCol = r.split('.')[1] || r;
            
            const joined = [];
            results.forEach(rowA => {
                DB[joinTable].forEach(rowB => {
                    // Simple join logic (Strings/Numbers equality)
                    if (rowA[lCol] == rowB[rCol] || rowA[rCol] == rowB[lCol]) {
                        joined.push({ ...rowA, ...rowB });
                    }
                });
            });
            results = joined;
        }

        // --- 2. WHERE ---
        const whereMatch = query.match(/WHERE\s+(.+?)(?=\s+(?:GROUP|ORDER|LIMIT|HAVING)|$)/i);
        if (whereMatch) {
            results = results.filter(row => this.evaluateCondition(row, whereMatch[1]));
        }

        // --- 3. GROUP BY & Aggregates ---
        const distinctMatch = query.match(/SELECT\s+(DISTINCT\s+)?(.+?)\s+FROM/i);
        let colsStr = distinctMatch[2].trim();
        const groupMatch = query.match(/GROUP\BY\s+(.+?)(?=\s+(?:ORDER|LIMIT|HAVING)|$)/i);
        
        let grouped = [];
        let isAgg = false;

        if (groupMatch) {
            isAgg = true;
            const keyCol = groupMatch[1].trim();
            const groups = {};
            results.forEach(row => {
                const k = row[keyCol];
                if (!groups[k]) groups[k] = [];
                groups[k].push(row);
            });
            grouped = Object.keys(groups).map(k => ({ key: k, rows: groups[k] }));
        } else if (['COUNT', 'SUM', 'AVG', 'MAX', 'MIN'].some(op => colsStr.toUpperCase().includes(op))) {
            isAgg = true;
            grouped = [{ key: 'ALL', rows: results }];
        }

        // --- 4. HAVING ---
        const havingMatch = query.match(/HAVING\s+(.+?)(?=\s+(?:ORDER|LIMIT)|$)/i);
        if (havingMatch && isAgg) {
            grouped = grouped.filter(g => this.evaluateHaving(g.rows, havingMatch[1]));
        }

        // --- 5. AGGREGATE PROJECTION / WINDOW FUNCTIONS ---
        if (isAgg) {
            // Flatten groups back to rows
            results = grouped.map(g => {
                const rows = g.rows;
                const ret = {};
                const reqCols = this.splitColumns(colsStr);
                reqCols.forEach(req => {
                    const up = req.toUpperCase();
                    if (up.includes('COUNT(*)')) ret['count(*)'] = rows.length;
                    else if (up.includes('SUM')) {
                        const col = req.match(/\((.+)\)/)[1];
                        ret[`sum(${col})`] = rows.reduce((s, r) => s + (parseFloat(r[col])||0), 0);
                    } else if (up.includes('AVG')) {
                        const col = req.match(/\((.+)\)/)[1];
                        const sum = rows.reduce((s, r) => s + (parseFloat(r[col])||0), 0);
                        ret[`avg(${col})`] = parseFloat((sum/rows.length).toFixed(2));
                    } else {
                        ret[req] = rows[0][req]; // Group key
                    }
                });
                return ret;
            });
            colsStr = "*"; // Already projected
        }

        // --- 6. ORDER BY ---
        const orderMatch = query.match(/ORDER\BY\s+(.+?)(?=\s+LIMIT|$)/i);
        if (orderMatch) {
            const [col, dir] = orderMatch[1].trim().split(/\s+/);
            const isDesc = dir && dir.toUpperCase() === 'DESC';
            results.sort((a, b) => {
                let va = a[col] !== undefined ? a[col] : a[Object.keys(a).find(k=>k.toLowerCase()===col.toLowerCase())];
                let vb = b[col] !== undefined ? b[col] : b[Object.keys(b).find(k=>k.toLowerCase()===col.toLowerCase())];
                if(va === undefined) return 0;
                return (va < vb ? -1 : 1) * (isDesc ? -1 : 1);
            });
        }

        // --- 7. Window Functions (Applied after Sort) ---
        if (colsStr.toUpperCase().includes('OVER')) {
            results = this.applyWindowFunctions(results, colsStr);
        }

        // --- 8. LIMIT ---
        const limitMatch = query.match(/LIMIT\s+(\d+)(\s+OFFSET\s+(\d+))?/i);
        if (limitMatch) {
            const lim = parseInt(limitMatch[1]);
            const off = limitMatch[3] ? parseInt(limitMatch[3]) : 0;
            results = results.slice(off, off + lim);
        }

        // --- 9. FINAL PROJECTION (CASE, COALESCE, Columns) ---
        if (colsStr.trim() !== '*' && !isAgg) {
            const reqCols = this.splitColumns(colsStr);
            results = results.map(row => {
                const newRow = {};
                reqCols.forEach(col => {
                    if (col.toUpperCase().startsWith('CASE')) {
                        const alias = col.split(/\s+AS\s+/i)[1] || 'case_result';
                        newRow[alias] = this.evaluateCase(row, col);
                        return;
                    }
                    if (col.toUpperCase().startsWith('COALESCE')) {
                        const matches = col.match(/COALESCE\s*\((.+?)\s*,\s*(.+?)\)/i);
                        if(matches) {
                            const dbCol = matches[1].trim();
                            const fb = matches[2].trim().replace(/'/g, '');
                            const alias = col.split(/\s+AS\s+/i)[1] || dbCol;
                            newRow[alias] = (row[dbCol] == null) ? fb : row[dbCol];
                            return;
                        }
                    }
                    // Basic column selection
                    // Handle "table.col" syntax slightly
                    const key = col.includes('.') ? col.split('.')[1] : col;
                    // Check if window function added it (like row_num) or existing col
                    if (row[key] !== undefined) newRow[key] = row[key];
                    else if (row[col] !== undefined) newRow[col] = row[col];
                });
                return newRow;
            });
        }

        // --- 10. DISTINCT ---
        const isDistinct = !!distinctMatch[1];
        if (isDistinct) {
            const seen = new Set();
            results = results.filter(r => {
                const s = JSON.stringify(r);
                if (seen.has(s)) return false;
                seen.add(s);
                return true;
            });
        }

        return { data: results };
    },

    // Helpers
    evaluateCondition: function(row, cond) {
        if (cond.includes('(SELECT')) {
            const m = cond.match(/([a-z0-9_]+)\s*(=|>|<)\s*\((SELECT.+?)\)/i);
            if (m) {
                const subRes = this.execute(m[3]);
                if (subRes.data?.[0]) {
                    const val = Object.values(subRes.data[0])[0];
                    return eval(`${row[m[1]]} ${m[2]} ${val}`);
                }
            }
        }
        let js = cond.replace(/=/g, '==').replace(/\sAND\s/gi, '&&').replace(/\sOR\s/gi, '||').replace(/'/g, '"');
        if (js.toUpperCase().includes('IS NULL')) return row[js.split('IS NULL')[0].trim()] == null;
        try {
            Object.keys(row).forEach(k => {
                const v = typeof row[k] === 'string' ? `"${row[k]}"` : row[k];
                js = js.replace(new RegExp(`\\b${k}\\b`, 'g'), v);
            });
            return eval(js);
        } catch { return false; }
    },

    evaluateHaving: function(rows, cond) {
        const m = cond.match(/COUNT\(\*\)\s*(>|<|=|>=|<=)\s*(\d+)/i);
        if (m) {
            const op = m[1], val = parseInt(m[2]), cnt = rows.length;
            if (op === '>') return cnt > val;
            if (op === '==') return cnt === val; 
        }
        return false;
    },

    evaluateCase: function(row, str) {
        const when = str.match(/WHEN\s+(.+?)\s+THEN\s+(.+?)(?=\s+ELSE|\s+END)/i);
        if (when && this.evaluateCondition(row, when[1])) return when[2].replace(/'/g, '').trim();
        const el = str.match(/ELSE\s+(.+?)\s+END/i);
        return el ? el[1].replace(/'/g, '').trim() : null;
    },

    applyWindowFunctions: function(rows, selectStr) {
        return rows.map((row, index, array) => {
            const newRow = { ...row };
            if (selectStr.toUpperCase().includes('ROW_NUMBER')) newRow['row_num'] = index + 1;
            if (selectStr.toUpperCase().includes('RANK')) {
                let rank = 1;
                for(let i=0; i<index; i++) if (array[i].salary > array[index].salary) rank++;
                newRow['rank'] = rank;
            }
            if (selectStr.toUpperCase().includes('LAG(SALARY)')) newRow['prev_salary'] = index > 0 ? array[index-1].salary : null;
            return newRow;
        });
    }
};

/* ------------------------------------------------------------------
   3. CURRICULUM
------------------------------------------------------------------ */
const CURRICULUM = [
    {
        title: "Level 1-5: Foundations (Refresher)",
        lessons: [
            { id: 'l1', title: 'SELECT *', type: 'lesson', xp: 100, 
              content: '<h4>Your First Query</h4><p>Retrieve all columns from the users table.</p>', 
              defaultQuery: 'SELECT * FROM users', 
              validation: r => r.length === 4 },
            
            { id: 'l2', title: 'Specific Columns', type: 'lesson', xp: 150,
              content: '<h4>Choose Columns</h4><p>Select only name and email from users.</p>',
              defaultQuery: 'SELECT name, email FROM users',
              validation: r => r.length > 0 && r[0].name && r[0].email && !r[0].id },
            
            { id: 'l3', title: 'WHERE Clause', type: 'lesson', xp: 200,
              content: '<h4>Filtering Data</h4><p>Find all employees in the Sales department.</p>',
              defaultQuery: "SELECT * FROM employees WHERE department = 'Sales'",
              validation: r => r.every(x => x.department === 'Sales') },
            
            { id: 'l4', title: 'ORDER BY', type: 'lesson', xp: 200,
              content: '<h4>Sorting Results</h4><p>Get employees ordered by salary (highest first).</p>',
              defaultQuery: 'SELECT * FROM employees ORDER BY salary DESC',
              validation: r => r[0].salary >= r[r.length-1].salary },
            
            { id: 'l5', title: 'Aggregate Functions', type: 'lesson', xp: 300,
              content: '<h4>COUNT & AVG</h4><p>Find the average salary of all employees.</p><pre>SELECT AVG(salary) as avg_salary FROM employees</pre>',
              defaultQuery: 'SELECT AVG(salary) as avg_salary FROM employees',
              validation: r => r[0].avg_salary > 0 }
        ]
    },
    {
        title: "Level 6: Advanced Logic",
        lessons: [
            { id: 'l6_1', title: 'CASE Statement', type: 'lesson', xp: 500, 
              content: `<h4>Conditional Logic</h4><p>Use <code>CASE</code> to categorize data.</p><pre>SELECT name, salary, CASE WHEN salary > 60000 THEN 'High' ELSE 'Low' END as tier FROM employees</pre>`, 
              defaultQuery: "SELECT name, salary, CASE WHEN salary > 60000 THEN 'High' ELSE 'Low' END as tier FROM employees", validation: r => r[0].tier },
            { id: 'l6_2', title: 'Data Cleaning', type: 'lesson', xp: 600,
              content: `<h4>Handling NULLs</h4><p>Use <code>COALESCE</code> to fill missing values.</p><p><strong>Task:</strong> Select user names and fill null roles with 'Guest'.</p>`,
              defaultQuery: "SELECT name, COALESCE(role, 'Guest') as role FROM users", validation: r => r.some(x => x.role === 'Guest') }
        ]
    },
    {
        title: "Level 7: Subqueries & CTEs",
        lessons: [
            { id: 'l7_1', title: 'Subqueries', type: 'lesson', xp: 700,
              content: `<h4>Nested Queries</h4><p>Find employees who earn more than the average salary.</p><pre>SELECT * FROM employees WHERE salary > (SELECT AVG(salary) FROM employees)</pre>`,
              defaultQuery: "SELECT * FROM employees WHERE salary > (SELECT AVG(salary) FROM employees)", validation: r => r.length > 0 },
            { id: 'l7_2', title: 'CTEs (Common Table Expressions)', type: 'lesson', xp: 800,
              content: `<h4>Using WITH</h4><p>CTEs make queries readable. Define a temp table first.</p><pre>WITH HighEarners AS (SELECT * FROM employees WHERE salary > 60000) SELECT * FROM HighEarners</pre>`,
              defaultQuery: "WITH HighEarners AS (SELECT * FROM employees WHERE salary > 60000) SELECT * FROM HighEarners", validation: r => r.every(x => x.salary > 60000) }
        ]
    },
    {
        title: "Level 8: Window Functions",
        lessons: [
            { id: 'l8_1', title: 'ROW_NUMBER()', type: 'lesson', xp: 900,
              content: `<h4>Ranking Data</h4><p>Assign a unique index to rows.</p><pre>SELECT name, salary, ROW_NUMBER() OVER (ORDER BY salary DESC) as row_num FROM employees</pre>`,
              defaultQuery: "SELECT name, salary, ROW_NUMBER() OVER (ORDER BY salary DESC) as row_num FROM employees", validation: r => r[0].row_num === 1 },
            { id: 'l8_2', title: 'LAG & LEAD', type: 'lesson', xp: 1000,
              content: `<h4>Time Travel</h4><p>Compare current row with previous row.</p><pre>SELECT name, salary, LAG(salary) OVER (ORDER BY salary) as prev_salary FROM employees</pre>`,
              defaultQuery: "SELECT name, salary, LAG(salary) OVER (ORDER BY salary) as prev_salary FROM employees", validation: r => 'prev_salary' in r[0] }
        ]
    },
    {
        id: 'level5', title: 'Level 5: Database Structure (DDL)',
        lessons: [
            { id: 'ddl1', title: 'Command Types (Theory)', type: 'lesson', xp: 1000,
              content: `
                <h4 class="text-primary fw-bold">SQL Command Categories</h4>
                <p>SQL is divided into types based on what the commands do:</p>
                <div class="row g-3 mb-3">
                    <div class="col-md-6"><div class="card p-3 border-0 bg-light"><h6 class="text-success fw-bold">1. DDL (Definition)</h6><p class="small mb-0">Defines structure (CREATE, ALTER, DROP).</p></div></div>
                    <div class="col-md-6"><div class="card p-3 border-0 bg-light"><h6 class="text-success fw-bold">2. DML (Manipulation)</h6><p class="small mb-0">Manages data (INSERT, UPDATE, DELETE).</p></div></div>
                    <div class="col-md-6"><div class="card p-3 border-0 bg-light"><h6 class="text-success fw-bold">3. DCL (Control)</h6><p class="small mb-0">Permissions (GRANT, REVOKE).</p></div></div>
                </div>
                <div class="alert alert-info border-0 shadow-sm"><strong>Note:</strong> DDL changes structure, DML changes content.</div>
                <p>Click "Run" to complete this theory lesson.</p>
              `,
              defaultQuery: "SELECT 'I understand DDL and DML' AS status", validation: r => true },
            { id: 'ddl2', title: 'CREATE Table', type: 'lesson', xp: 1100,
              content: `
                <h4 class="text-primary fw-bold">Creating Tables</h4>
                <p>The <code>CREATE TABLE</code> command creates a new table in the database.</p>
                <pre>CREATE TABLE Students (id INT, name VARCHAR(50));</pre>
                <p><strong>Task:</strong> Run the CREATE command to create a Students table (Simulation).</p>
              `,
              defaultQuery: "CREATE TABLE Students (id INT, name VARCHAR(50))", validation: r => r.message !== undefined },
            { id: 'ddl3', title: 'ALTER Table', type: 'lesson', xp: 1150,
              content: `
                <h4 class="text-primary fw-bold">Modifying Tables</h4>
                <p>Use <code>ALTER TABLE</code> to add or remove columns.</p>
                <pre>ALTER TABLE Students ADD email VARCHAR(100);</pre>
                <p><strong>Task:</strong> Add an 'email' column to Students (Simulation).</p>
              `,
              defaultQuery: "ALTER TABLE Students ADD email VARCHAR(100)", validation: r => r.message !== undefined },
            { id: 'ddl4', title: 'DROP & TRUNCATE', type: 'lesson', xp: 1200,
              content: `
                <h4 class="text-primary fw-bold">Deleting Structures</h4>
                <ul><li><code>DROP TABLE</code>: Deletes the table AND data.</li><li><code>TRUNCATE TABLE</code>: Deletes data, keeps table.</li></ul>
                <p><strong>Task:</strong> Drop the 'Students' table (Simulation).</p>
              `,
              defaultQuery: "DROP TABLE Students", validation: r => r.message !== undefined }
        ]
    }
];

const CHEAT_SHEET = [
    { title: "SQL Acronyms", desc: "DDL (Definition), DML (Manipulation), DCL (Control), TCL (Transaction)" },
    { title: "SELECT Basics", desc: "SELECT col1, col2 FROM table → Choose specific columns<br>SELECT * FROM table → Get all columns" },
    { title: "WHERE Filters", desc: "WHERE age > 18 AND city = 'NYC'<br>WHERE name LIKE '%John%' → Pattern matching<br>WHERE id IN (1,2,3) → Multiple values" },
    { title: "Aggregations", desc: "COUNT(*), SUM(col), AVG(col), MAX(col), MIN(col)<br>Must use GROUP BY when mixing with regular columns" },
    { title: "JOINs", desc: "INNER JOIN → Only matching rows<br>LEFT JOIN → All from left + matches<br>RIGHT JOIN → All from right + matches<br>FULL JOIN → All rows from both" },
    { title: "GROUP BY", desc: "SELECT dept, COUNT(*) FROM emp GROUP BY dept<br>Groups rows sharing same value<br>Use HAVING to filter groups" },
    { title: "ORDER BY", desc: "ORDER BY col ASC → Ascending (default)<br>ORDER BY col DESC → Descending<br>Can order by multiple columns" },
    { title: "Window Functions", desc: "ROW_NUMBER() OVER (ORDER BY col) → Unique row numbers<br>RANK() → Rank with gaps<br>LAG(col)/LEAD(col) → Previous/next row value<br>Does NOT collapse rows like GROUP BY" },
    { title: "CTEs", desc: "WITH temp AS (SELECT ...) SELECT * FROM temp<br>Creates readable temporary result sets<br>Can chain multiple CTEs" },
    { title: "NULL Handling", desc: "IS NULL / IS NOT NULL → Check for null<br>COALESCE(col, 'default') → First non-null value<br>NULLIF(a, b) → Returns null if a=b" },
    { title: "CASE Statements", desc: "CASE WHEN condition THEN value ELSE default END<br>Like if-else in SQL" },
    { title: "Subqueries", desc: "WHERE col > (SELECT AVG(col) FROM table)<br>Can use in SELECT, WHERE, FROM clauses" },
    { title: "DISTINCT", desc: "SELECT DISTINCT col FROM table → Remove duplicates" },
    { title: "LIMIT/TOP", desc: "LIMIT 10 → First 10 rows (MySQL/PostgreSQL)<br>TOP 10 → First 10 rows (SQL Server)" },
    { title: "Execution Order", desc: "FROM → ON → JOIN → WHERE → GROUP BY → HAVING → SELECT → DISTINCT → ORDER BY → LIMIT<br>Remember: WHERE filters rows, HAVING filters groups" }
];

/* ------------------------------------------------------------------
   4. APP LOGIC
------------------------------------------------------------------ */
const app = {
    state: { current: null, completed: [], xp: 0, theme: 'light' },

    init: function() {
        const s = JSON.parse(localStorage.getItem('sqlState')) || {};
        this.state = { ...this.state, ...s };
        this.applyTheme();
        this.renderSidebar();
        this.renderLanding();
        this.updateXP();
    },

    toggleTheme: function() {
        this.state.theme = this.state.theme === 'light' ? 'dark' : 'light';
        this.applyTheme();
        this.saveState();
    },

    applyTheme: function() {
        document.documentElement.setAttribute('data-theme', this.state.theme);
        const icon = document.getElementById('theme-icon');
        icon.className = this.state.theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
    },

    toggleSidebar: function(show) {
        const sb = document.getElementById('sidebar');
        const bd = document.getElementById('sidebarBackdrop');
        if(show) { sb.classList.add('active'); bd.classList.add('active'); }
        else { sb.classList.remove('active'); bd.classList.remove('active'); }
    },

    saveState: function() {
        localStorage.setItem('sqlState', JSON.stringify(this.state));
    },

    // --- Core Renderers ---
    renderSidebar: function() {
        const container = document.getElementById('curriculumAccordion');
        container.innerHTML = CURRICULUM.map((lvl, i) => `
            <div class="accordion-item level-accordion">
                <h2 class="accordion-header"><button class="accordion-button ${i===0?'':'collapsed'}" type="button" data-bs-toggle="collapse" data-bs-target="#c${i}">${lvl.title}</button></h2>
                <div id="c${i}" class="accordion-collapse collapse ${i===0?'show':''}" data-bs-parent="#curriculumAccordion">
                    <div class="accordion-body p-0">
                        ${lvl.lessons.map(l => `
                            <div class="lesson-item ${this.state.completed.includes(l.id)?'completed':''} ${this.state.current===l.id?'active':''}" onclick="app.loadLesson('${l.id}')">
                                <span>${l.title}</span> ${this.state.completed.includes(l.id)?'<i class="fas fa-check-circle"></i>':`<span class="badge bg-light text-dark">${l.xp}XP</span>`}
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `).join('');
    },

    renderLanding: function() {
        document.getElementById('content-area').innerHTML = `
            <div class="landing-container">
                <div class="floating-blob" style="top:-50px; left:-50px;"></div>
                <div class="hero-card fade-in">
                    <div class="mb-4 d-inline-block p-4 rounded-circle bg-white shadow-sm"><i class="fas fa-database fa-4x text-primary"></i></div>
                    <h1 class="display-4 fw-bold mb-3">Jackie's SQL ❤️</h1>
                    <p class="lead text-muted mb-4">From Beginner to Interview Ready.</p>
                    <button class="btn btn-primary btn-lg rounded-pill px-5 shadow-lg" onclick="app.loadLesson('l1')">Start Journey</button>
                </div>
            </div>`;
    },

    loadLesson: function(id) {
        this.toggleSidebar(false); // Fix for mobile nav issue
        this.state.current = id;
        this.renderSidebar();
        
        let lesson = CURRICULUM.flatMap(l=>l.lessons).find(l=>l.id===id);
        const content = lesson ? lesson.content : "<h3>Playground</h3><p>Experiment freely.</p>";
        const query = lesson ? lesson.defaultQuery : "SELECT * FROM employees";

        document.getElementById('content-area').innerHTML = `
            <div class="d-flex flex-column h-100 fade-in">
                <div class="lesson-instructions">${content}</div>
                <div class="editor-area">
                    <div class="editor-col">
                        <div class="code-editor-container">
                            <div class="editor-with-lines">
                                <div class="line-numbers" id="line-numbers">1</div>
                                <textarea id="sql-editor" oninput="app.updateLineNumbers()">${query}</textarea>
                            </div>
                            <div class="p-3 border-top border-secondary border-opacity-10 bg-surface d-flex justify-content-between align-items-center">
                                <button class="btn-run" onclick="app.run('${id}')"><i class="fas fa-play"></i> Run</button>
                                <button class="btn btn-sm btn-outline-primary" onclick="app.explainAI()">✨ Explain</button>
                            </div>
                        </div>
                        <div id="status-msg" class="status-msg"></div>
                    </div>
                    <div class="results-col ms-lg-3 mt-3 mt-lg-0">
                        <div class="results-area">
                            <div class="results-header"><span>Results</span></div>
                            <div class="results-content p-0" id="results-out"><div class="h-100 d-flex align-items-center justify-content-center text-muted">Run query...</div></div>
                        </div>
                    </div>
                </div>
            </div>`;
        this.updateLineNumbers();
        
        // Scroll sync fix for line numbers
        const ta = document.getElementById('sql-editor');
        const ln = document.getElementById('line-numbers');
        ta.addEventListener('scroll', () => { ln.scrollTop = ta.scrollTop; });
    },

    updateLineNumbers: function() {
        const editor = document.getElementById('sql-editor');
        const lineNum = document.getElementById('line-numbers');
        if (!editor || !lineNum) return;
        const lines = editor.value.split('\n').length;
        lineNum.innerHTML = Array.from({length: lines}, (_, i) => i + 1).join('<br>');
    },

    run: function(id) {
        const sql = document.getElementById('sql-editor').value;
        const msg = document.getElementById('status-msg');
        const out = document.getElementById('results-out');
        const editor = document.querySelector('.code-editor-container');
        
        editor.classList.remove('success-glow');
        msg.style.display = 'none';

        const res = SQLEngine.execute(sql);

        if(res.error) {
            out.innerHTML = `<div class="p-4 text-center text-danger"><i class="fas fa-exclamation-triangle fa-2x mb-3"></i><br>${res.error}</div>`;
            return;
        }

        if(res.message) {
             out.innerHTML = `<div class="p-4 text-center text-success"><i class="fas fa-check-circle fa-2x mb-3"></i><br>${res.message}</div>`;
             // Allow completing Simulation lessons
             const l = CURRICULUM.flatMap(l=>l.lessons).find(l=>l.id===id);
             if(l && l.validation && l.validation(res)) {
                 this.handleSuccess(id, l, msg, editor);
             }
             return;
        }

        // Render Table
        if(!res.data.length) {
            out.innerHTML = `<div class="p-4 text-center text-muted">No results found.</div>`;
        } else {
            const cols = Object.keys(res.data[0]);
            out.innerHTML = `<table class="table-custom"><thead><tr>${cols.map(c=>`<th>${c}</th>`).join('')}</tr></thead><tbody>${res.data.map(r=>`<tr>${cols.map(c=>`<td>${r[c]}</td>`).join('')}</tr>`).join('')}</tbody></table>`;
        }

        // Validation
        const lesson = CURRICULUM.flatMap(l=>l.lessons).find(l=>l.id===id);
        if(lesson && lesson.validation) {
            try {
                if(lesson.validation(res.data)) {
                    this.handleSuccess(id, lesson, msg, editor);
                } else {
                    msg.className = 'status-msg status-error';
                    msg.innerHTML = '<strong>Not quite right.</strong> Check the expected output.';
                    msg.style.display = 'block';
                }
            } catch(e) {}
        }
    },

    handleSuccess: function(id, lesson, msg, editor) {
        if(!this.state.completed.includes(id)) {
            this.state.completed.push(id);
            this.state.xp += lesson.xp;
            this.saveState();
            this.updateXP();
            this.renderSidebar();
        }
        const tips = ['Great job!', 'Perfect!', 'Excellent!', 'Nailed it!'];
        const tip = tips[Math.floor(Math.random() * tips.length)];
        msg.className = 'status-msg status-success';
        msg.innerHTML = `<strong>${tip}</strong> +${lesson.xp} XP`;
        msg.style.display = 'block';
        editor.classList.add('success-glow');
    },

    // --- Helpers ---
    updateXP: function() {
        document.getElementById('total-xp').innerText = `${this.state.xp} XP`;
        let total = 0; CURRICULUM.forEach(l => total += l.lessons.length);
        const pct = Math.round((this.state.completed.length / total) * 100);
        document.getElementById('overall-progress').style.width = `${pct}%`;
    },
    
    resetProgress: function() {
        if(confirm("Reset all progress?")) {
            this.state.completed = []; this.state.xp = 0;
            this.saveState(); this.init();
        }
    },

    showCheatSheet: function() {
        const c = document.getElementById('cheat-sheet-content');
        c.innerHTML = CHEAT_SHEET.map(i => `<div class="col-md-6"><div class="p-3 border rounded h-100" style="background:var(--bg-main);"><h6 class="text-primary fw-bold">${i.title}</h6><p class="small mb-0 text-muted">${i.desc}</p></div></div>`).join('');
        new bootstrap.Modal(document.getElementById('cheatSheetModal')).show();
    },

    showSchema: function() {
        const c = document.getElementById('schema-container');
        c.innerHTML = Object.keys(DB).map(k => `<div class="col-md-6"><div class="p-3 border rounded" style="background:var(--bg-main);"><h6 class="text-primary fw-bold text-uppercase small">${k}</h6><div class="small text-muted">${Object.keys(DB[k][0]).join(', ')}</div></div></div>`).join('');
        new bootstrap.Modal(document.getElementById('schemaModal')).show();
    },

    // --- AI Stub ---
    async explainAI() {
        const sql = document.getElementById('sql-editor').value;
        const modal = new bootstrap.Modal(document.getElementById('aiModal'));
        document.getElementById('aiModalContent').innerHTML = '<div class="text-center p-4"><i class="fas fa-spinner fa-spin text-primary fa-2x"></i><p class="mt-2">Analyzing...</p></div>';
        modal.show();
        
        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ contents: [{ parts: [{ text: `Explain SQL simply: ${sql}` }] }] })
            });
            const data = await res.json();
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "Error generating explanation.";
            document.getElementById('aiModalContent').innerHTML = `<div style="line-height:1.6">${text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</div>`;
        } catch(e) {
            document.getElementById('aiModalContent').innerText = "AI Service Unavailable (Check API Key)";
        }
    }
};

document.addEventListener('DOMContentLoaded', () => app.init());

document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        const lessonId = app.state.current;
        if (lessonId) app.run(lessonId);
    }
    if ((e.ctrlKey || e.metaKey) && e.key === '/') {
        e.preventDefault();
        const editor = document.getElementById('sql-editor');
        if (editor) {
            const lines = editor.value.split('\n');
            editor.value = lines.map(l => l.startsWith('-- ') ? l.slice(3) : '-- ' + l).join('\n');
        }
    }
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>